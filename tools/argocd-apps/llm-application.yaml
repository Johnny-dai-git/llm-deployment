apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: llm-platform-services
  namespace: argocd
  annotations:
    # ArgoCD Image Updater configuration
    # 启用 Image Updater（必须！没有这个 Image Updater 会忽略此 Application）
    argocd-image-updater.argoproj.io/enabled: "true"
    # 集中管理所有服务的镜像更新配置
    # image-list 格式：单行，用逗号分隔（更稳妥，避免 YAML/CRLF 解析问题）
    argocd-image-updater.argoproj.io/image-list: llm-api=ghcr.io/johnny-dai-git/llm-deployment/gateway,router=ghcr.io/johnny-dai-git/llm-deployment/router,vllm-worker=ghcr.io/johnny-dai-git/llm-deployment/vllm-worker,trt-worker=ghcr.io/johnny-dai-git/llm-deployment/trt-worker,web=ghcr.io/johnny-dai-git/llm-deployment/web
    # llm-api (gateway) 配置
    argocd-image-updater.argoproj.io/llm-api.update-strategy: name
    argocd-image-updater.argoproj.io/llm-api.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    # router 配置
    argocd-image-updater.argoproj.io/router.update-strategy: name
    argocd-image-updater.argoproj.io/router.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    # vllm-worker 配置
    argocd-image-updater.argoproj.io/vllm-worker.update-strategy: name
    argocd-image-updater.argoproj.io/vllm-worker.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    # trt-worker 配置
    argocd-image-updater.argoproj.io/trt-worker.update-strategy: name
    argocd-image-updater.argoproj.io/trt-worker.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    # web 配置
    argocd-image-updater.argoproj.io/web.update-strategy: name
    argocd-image-updater.argoproj.io/web.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    # ArgoCD 写回配置（推荐：直接 patch Application，无需 Git token）
    # ⚠️ 重要：使用 argocd 模式可以避免 GitHub Push Protection 问题
    # Image Updater 会直接 patch ArgoCD Application，然后 ArgoCD 自动同步 Deployment
    argocd-image-updater.argoproj.io/write-back-method: argocd
  # 注意：业务 Application 不建议使用 finalizer
  # 原因：删除时容易卡住，不利于快速回滚/重建环境
  # 如果需要"删 Application 就删全部业务资源"，可以保留；否则建议移除
  # finalizers:
  #   - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/Johnny-dai-git/llm-deployment.git
    targetRevision: main
    path: tools/config/llm
  destination:
    server: https://kubernetes.default.svc
    namespace: llm
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
