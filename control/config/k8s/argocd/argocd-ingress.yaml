apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-server-ingress
  namespace: argocd
  annotations:
    # ArgoCD 使用 HTTP + gRPC-Web（不是纯 gRPC）
    # ⚠️ 重要：必须使用 HTTP，不能使用 GRPC
    # Image Updater 配置中已使用 grpcWeb: true，这里必须匹配
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    # 不强制 SSL 重定向（如果使用 HTTP）
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # 路径重写：去掉 /argocd 前缀，转发到后端
    # 浏览器请求 /argocd/api/v1/session → 后端收到 /api/v1/session
    # ⚠️ 必须配置，否则路径不匹配会导致登录失败、API 调用失败
    nginx.ingress.kubernetes.io/rewrite-target: /
    # 增加超时时间（gRPC-Web 可能需要更长时间）
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    # 允许大请求体（用于同步大型应用）
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  ingressClassName: nginx
  rules:
  - http:
      paths:
      - path: /argocd
        pathType: Prefix
        backend:
          service:
            name: argocd-server
            port:
              number: 80
