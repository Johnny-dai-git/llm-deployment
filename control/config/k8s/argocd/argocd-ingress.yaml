# =========================
# ⚠️ 已弃用：此 Ingress 已合并到 llm/ingress/unified-ingress.yaml
# =========================
# ArgoCD 路径现在通过统一的 Ingress 管理：
# - /argocd → ArgoCD UI (在 llm namespace 的 unified-ingress.yaml 中)
#
# 注意：由于 ArgoCD Application 的 prune: true，此文件从 Git 删除后，
# ArgoCD 会自动从集群中删除对应的 Ingress 资源。
#
# 建议：在确认 unified-ingress.yaml 正常工作后，可以删除此文件。

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-server-ingress
  namespace: argocd
  annotations:
    # ArgoCD 使用 HTTP + gRPC-Web（不是纯 gRPC）
    # ⚠️ 重要：必须使用 HTTP，不能使用 GRPC
    # Image Updater 配置中已使用 grpcWeb: true，这里必须匹配
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    # 不强制 SSL 重定向（如果使用 HTTP）
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # 路径重写：去掉 /argocd 前缀，转发到后端
    # 浏览器请求 /argocd/api/v1/session → 后端收到 /api/v1/session
    # ⚠️ 必须配置，否则路径不匹配会导致登录失败、API 调用失败
    nginx.ingress.kubernetes.io/rewrite-target: /
    # 增加超时时间（gRPC-Web 可能需要更长时间）
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    # 允许大请求体（用于同步大型应用）
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  ingressClassName: nginx
  rules:
  - http:
      paths:
      - path: /argocd
        pathType: Prefix
        backend:
          service:
            name: argocd-server
            port:
              number: 80
