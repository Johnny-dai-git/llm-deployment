# =========================
# Deployment 示例：带 Image Updater Annotations
# =========================
# 注意：这是示例配置，展示如何在 Deployment 中添加 Image Updater annotations
#
# 使用说明：
# 1. 将下面的 annotations 添加到你的 Deployment metadata 中
# 2. 修改占位符值：
#    - YOUR_REGISTRY: 你的 Docker registry 地址
#    - YOUR_IMAGE_NAME: 你的 image 名称
#    - 更新策略：semver, latest, name, digest 等
#
# 示例：llm-api-deployment.yaml 的完整配置

apiVersion: apps/v1
kind: Deployment
metadata:
  name: llm-api
  namespace: llm
  labels:
    app: llm-api
  annotations:
    # ============================================
    # ArgoCD Image Updater configuration
    # ============================================
    
    # 指定要监控的 image 列表
    # 格式：alias=registry/image-name
    # 如果有多个 image，用逗号分隔
    argocd-image-updater.argoproj.io/image-list: |
      llm-api=YOUR_REGISTRY/YOUR_IMAGE_NAME
    
    # 更新策略：semver（语义化版本）, latest, name, digest
    # semver: 匹配语义化版本号（如 v1.2.3）
    # latest: 总是使用最新的 tag
    # name: 按名称排序选择最新的（实际部署使用此策略）
    # digest: 使用 image digest
    argocd-image-updater.argoproj.io/llm-api.update-strategy: name
    
    # 允许的 tag 模式（正则表达式）
    # 只更新匹配此模式的 tag
    # 示例1: 语义化版本号模式
    # argocd-image-updater.argoproj.io/llm-api.allow-tags: regexp:^v?[0-9]+\.[0-9]+\.[0-9]+$
    # 示例2: 时间戳模式（实际部署使用此模式）
    argocd-image-updater.argoproj.io/llm-api.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    
    # 忽略的 tag 模式（可选）
    # argocd-image-updater.argoproj.io/llm-api.ignore-tags: regexp:^.*-dev$
    
    # 写回 Git 的方法（必须包含 secret 引用）
    argocd-image-updater.argoproj.io/write-back-method: git:secret:argocd/git-credentials
    
    # Git 分支
    argocd-image-updater.argoproj.io/git-branch: main
    
    # Git commit 消息模板（可选）
    # argocd-image-updater.argoproj.io/write-back-commit-message: "chore: update {{.AppName}} image to {{.NewTag}}"
    
    # 如果使用私有 registry，需要指定 pull secret（用于 Image Updater 拉取镜像元数据）
    # 注意：这与 Deployment 中的 imagePullSecrets 不同
    # 注意：如果镜像都是 public 的，则不需要配置此选项
    # argocd-image-updater.argoproj.io/llm-api.pull-secret: pullsecret:argocd/docker-registry-secret#.dockerconfigjson

spec:
  replicas: 2
  selector:
    matchLabels:
      app: llm-api
  template:
    metadata:
      labels:
        app: llm-api
    spec:
      # 如果使用私有 registry，需要配置 imagePullSecrets
      # 注意：如果镜像都是 public 的（如当前配置），则不需要 imagePullSecrets
      # imagePullSecrets:
      #   - name: ghcr-secret  # 仅在使用私有镜像时需要
      nodeSelector:
        system: "true"
      containers:
      - name: llm-api
        # Image Updater 会自动更新这个 tag
        # 初始值可以是 latest 或具体的版本号
        image: YOUR_REGISTRY/YOUR_IMAGE_NAME:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8000
          protocol: TCP
        # ... 其他配置 ...

---
# ============================================
# 多 Image 示例（如果有多个容器）
# ============================================
# 如果你的 Deployment 有多个容器需要自动更新：

# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: multi-container-app
#   namespace: llm
#   annotations:
#     # 多个 image，用逗号分隔
#     argocd-image-updater.argoproj.io/image-list: |
#       api=YOUR_REGISTRY/api-image,
#       worker=YOUR_REGISTRY/worker-image
#     
#     # 为每个 image 配置不同的更新策略
#     argocd-image-updater.argoproj.io/api.update-strategy: semver
#     argocd-image-updater.argoproj.io/api.allow-tags: regexp:^v?[0-9]+\.[0-9]+\.[0-9]+$
#     
#     argocd-image-updater.argoproj.io/worker.update-strategy: latest
#     
#     argocd-image-updater.argoproj.io/write-back-method: git:secret:argocd/git-credentials
#     argocd-image-updater.argoproj.io/git-branch: main
# spec:
#   template:
#     spec:
#       containers:
#       - name: api
#         image: YOUR_REGISTRY/api-image:latest
#       - name: worker
#         image: YOUR_REGISTRY/worker-image:latest

---
# ============================================
# 更新策略说明
# ============================================
#
# 1. semver（语义化版本）：
#    - 匹配 v1.2.3, 1.2.3, v1.2.3-beta 等
#    - 总是选择最新的版本号
#    - 推荐用于生产环境
#
# 2. latest：
#    - 总是使用 latest tag
#    - 简单但不推荐用于生产
#
# 3. name：
#    - 按名称排序，选择最新的
#    - 适用于自定义命名规则
#
# 4. digest：
#    - 使用 image digest（SHA256）
#    - 最安全但需要手动触发更新

