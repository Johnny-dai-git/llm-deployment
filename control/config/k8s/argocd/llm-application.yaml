apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: llm-platform-services
  namespace: argocd
  annotations:
    # ArgoCD Image Updater configuration
    # 集中管理所有服务的镜像更新配置
    argocd-image-updater.argoproj.io/image-list: |
      llm-api=ghcr.io/johnny-dai-git/llm-deployment/gateway,
      router=ghcr.io/johnny-dai-git/llm-deployment/router,
      vllm-worker=ghcr.io/johnny-dai-git/llm-deployment/vllm-worker,
      trt-worker=ghcr.io/johnny-dai-git/llm-deployment/trt-worker,
      web=ghcr.io/johnny-dai-git/llm-deployment/web
    # llm-api (gateway) 配置
    argocd-image-updater.argoproj.io/llm-api.update-strategy: name
    argocd-image-updater.argoproj.io/llm-api.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    # router 配置
    argocd-image-updater.argoproj.io/router.update-strategy: name
    argocd-image-updater.argoproj.io/router.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    # vllm-worker 配置
    argocd-image-updater.argoproj.io/vllm-worker.update-strategy: name
    argocd-image-updater.argoproj.io/vllm-worker.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    # trt-worker 配置
    argocd-image-updater.argoproj.io/trt-worker.update-strategy: name
    argocd-image-updater.argoproj.io/trt-worker.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    # web 配置
    argocd-image-updater.argoproj.io/web.update-strategy: name
    argocd-image-updater.argoproj.io/web.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    # Git 写回配置（所有服务共用）
    argocd-image-updater.argoproj.io/write-back-method: git:secret:argocd/git-credentials
    argocd-image-updater.argoproj.io/git-branch: main
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://github.com/Johnny-dai-git/llm-deployment.git
    targetRevision: main
    path: control/config/k8s/llm
  destination:
    server: https://kubernetes.default.svc
    namespace: llm
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true

