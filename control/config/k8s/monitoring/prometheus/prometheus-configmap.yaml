apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
  labels:
    app: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 5s
      scrape_timeout: 5s
      evaluation_interval: 15s

    scrape_configs:

    # --- Kubernetes Cluster-level metrics ---
    - job_name: "kube-state-metrics"
      static_configs:
        - targets: ["kube-state-metrics.monitoring.svc:8080"]

    # node-exporter 使用 hostNetwork，需要通过节点发现来抓取
    # 因为 hostNetwork: true，每个节点上的 node-exporter 绑定到节点的 9100 端口
    - job_name: "node-exporter"
      kubernetes_sd_configs:
        - role: node
      relabel_configs:
        # 使用节点名称作为 instance 标签
        - source_labels: [__meta_kubernetes_node_name]
          action: replace
          target_label: instance
        # 将地址从 kubelet 端口 (10250) 改为 node-exporter 端口 (9100)
        # __address__ 默认是 InternalIP:10250，我们需要改为 InternalIP:9100
        - source_labels: [__address__]
          action: replace
          regex: ([^:]+):\d+
          replacement: ${1}:9100
          target_label: __address__
        # 设置 metrics 路径
        - action: replace
          target_label: __metrics_path__
          replacement: /metrics

    - job_name: "dcgm-exporter"
      static_configs:
        - targets: ["dcgm-exporter.monitoring.svc:9400"]

    # --- LLM System Monitoring (Your Services) - Kubernetes Service Discovery ---
    - job_name: "kubernetes-pods-llm"
      kubernetes_sd_configs:
        - role: pod
          namespaces:
            names:
              - llm
      relabel_configs:
        # 只抓取有 prometheus.io/scrape: "true" annotation 的 Pod
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: true
        # 使用 annotation 指定的端口替换 __address__ 中的端口（如果annotation存在）
        - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(.+)
          replacement: $1:$2
          target_label: __address__
        # 先设置默认 metrics 路径为 /metrics
        - action: replace
          target_label: __metrics_path__
          replacement: /metrics
        # 如果 annotation 存在，使用 annotation 指定的路径覆盖默认值
        - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          target_label: __metrics_path__
          regex: (.+)
          replacement: ${1}
        # 添加 Pod 标签到 metrics
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        # 添加 namespace 标签
        - source_labels: [__meta_kubernetes_namespace]
          action: replace
          target_label: kubernetes_namespace
        # 添加 Pod 名称标签
        - source_labels: [__meta_kubernetes_pod_name]
          action: replace
          target_label: kubernetes_pod_name
        # 添加容器名称标签
        - source_labels: [__meta_kubernetes_pod_container_name]
          action: replace
          target_label: kubernetes_container_name
        # 添加 job 标签（从 Pod 的 app 标签获取）
        - source_labels: [__meta_kubernetes_pod_label_app]
          action: replace
          target_label: job
          regex: (.+)
          replacement: ${1}

