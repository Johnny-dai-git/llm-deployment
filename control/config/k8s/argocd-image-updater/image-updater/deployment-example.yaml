# =========================
# Image Updater 配置说明和示例
# =========================
#
# ⚠️ 重要说明：Image Updater 实际作用在 ArgoCD Application 上，不是 Deployment
#
# Image Updater 的工作流程：
# 1. 扫描 ArgoCD Application（读取 Application 的 annotations）
# 2. 找到 Application 管理的 manifests（如 Deployment）
# 3. 写回 Git（更新 Git 仓库中的 YAML 文件）
# 4. 由 ArgoCD Sync Deployment（ArgoCD 检测到 Git 变化后自动同步）
#
# ⚠️ Deployment 本身不会被 Image Updater 直接 patch
# ⚠️ Deployment 中的 annotations 只有在该 Deployment 由 ArgoCD Application 管理、
#    并启用 Git write-back 时才会生效
#
# ✅ 推荐做法：
# 将 Image Updater annotations 添加到 ArgoCD Application（参考 llm-application.yaml）
#
# ============================================
# 示例 1：ArgoCD Application 配置（推荐）
# ============================================
# 这是正确的配置方式，将 annotations 放在 Application 上：

# apiVersion: argoproj.io/v1alpha1
# kind: Application
# metadata:
#   name: llm-platform-services
#   namespace: argocd
#   annotations:
#     argocd-image-updater.argoproj.io/enabled: "true"
#     # 单 image 时，不用 | 多行格式，直接单行（避免解析问题）
#     argocd-image-updater.argoproj.io/image-list: llm-api=ghcr.io/your-org/llm-api
#     argocd-image-updater.argoproj.io/llm-api.update-strategy: name
#     argocd-image-updater.argoproj.io/llm-api.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
#     # 写回 Git 的前提条件：
#     # - Application 使用 Git source（不是 Helm repo、不是 Kustomize remote）
#     # - ArgoCD 对这个 repo 有写权限
#     # - Image Updater 使用的是 Git 模式（不是 argocd 模式）
#     argocd-image-updater.argoproj.io/write-back-method: git:secret:argocd/git-credentials
#     argocd-image-updater.argoproj.io/git-branch: main
# spec:
#   source:
#     repoURL: https://github.com/your-org/your-repo.git
#     targetRevision: main
#     path: control/config/k8s/llm

# ============================================
# 示例 2：Deployment 中的 annotations（仅当 Deployment 由 Application 管理时生效）
# ============================================
# ⚠️ 注意：这个示例只是为了说明，实际应该将 annotations 放在 Application 上
# ⚠️ 只有在以下情况下才会生效：
#    - 该 Deployment 由 ArgoCD Application 管理
#    - Application 启用了 Git write-back
#    - Image Updater 能够读取到 Application 的 annotations

apiVersion: apps/v1
kind: Deployment
metadata:
  name: llm-api
  namespace: llm
  labels:
    app: llm-api
  annotations:
    # ============================================
    # ArgoCD Image Updater configuration
    # ============================================
    # ⚠️ 注意：这些 annotations 应该放在管理此 Deployment 的 ArgoCD Application 上
    # ⚠️ 单 image 时，不用 | 多行格式，直接用单行（避免缩进或 CRLF 解析问题）
    argocd-image-updater.argoproj.io/image-list: llm-api=YOUR_REGISTRY/YOUR_IMAGE_NAME
    
    # 更新策略：semver（语义化版本）, latest, name, digest
    # semver: 匹配语义化版本号（如 v1.2.3）
    # latest: 总是使用最新的 tag
    # name: 按 tag 的字符串排序选择最新的（不是按时间，不是按 push 时间）
    #        ⚠️ 注意：name 策略只有在 tag 是严格 zero-padded 的时间戳时才安全
    #        例如：v-20240101-235959 ✅ (字符串顺序 = 时间顺序)
    #              v-2024-1-2-093000 ❌ (字符串顺序 ≠ 时间顺序)
    argocd-image-updater.argoproj.io/llm-api.update-strategy: name
    
    # 允许的 tag 模式（正则表达式）
    # 只更新匹配此模式的 tag
    # 示例1: 语义化版本号模式
    # argocd-image-updater.argoproj.io/llm-api.allow-tags: regexp:^v?[0-9]+\.[0-9]+\.[0-9]+$
    # 示例2: 时间戳模式（实际部署使用此模式，必须 zero-padded）
    argocd-image-updater.argoproj.io/llm-api.allow-tags: regexp:^v-[0-9]{8}-[0-9]{6}$
    
    # 忽略的 tag 模式（可选）
    # argocd-image-updater.argoproj.io/llm-api.ignore-tags: regexp:^.*-dev$
    
    # 写回 Git 的方法（必须包含 secret 引用）
    # ⚠️ 前提条件：此配置仅适用于 ArgoCD Application 使用 Git 仓库作为 source 的场景
    #    - Application 使用 Git source（不是 Helm repo、不是 Kustomize remote）
    #    - ArgoCD 对这个 repo 有写权限
    #    - Image Updater 使用的是 Git 模式（不是 argocd 模式）
    argocd-image-updater.argoproj.io/write-back-method: git:secret:argocd/git-credentials
    
    # Git 分支
    argocd-image-updater.argoproj.io/git-branch: main
    
    # Git commit 消息模板（可选）
    # argocd-image-updater.argoproj.io/write-back-commit-message: "chore: update {{.AppName}} image to {{.NewTag}}"
    
    # ⚠️ 如果镜像都是 public 的，则不需要配置 pull-secret
    # ⚠️ Image Updater 的 pull-secret 与 Deployment 的 imagePullSecrets 不同：
    #    - Image Updater 的 pull-secret：只用于读取 registry metadata（tags）
    #    - Deployment 的 imagePullSecrets：用于 kubelet 真正拉取镜像
    #    - 两者互不复用：Image Updater 能拉镜像 ≠ Pod 能拉镜像
    # argocd-image-updater.argoproj.io/llm-api.pull-secret: pullsecret:argocd/docker-registry-secret#.dockerconfigjson

spec:
  replicas: 2
  selector:
    matchLabels:
      app: llm-api
  template:
    metadata:
      labels:
        app: llm-api
    spec:
      # ⚠️ 如果镜像都是 public 的（如当前配置），则不需要 imagePullSecrets
      # ⚠️ 注意：这与 Image Updater 的 pull-secret 不同（见上方注释）
      # imagePullSecrets:
      #   - name: ghcr-secret  # 仅在使用私有镜像时需要
      nodeSelector:
        system: "true"
      containers:
      - name: llm-api
        # Image Updater 会自动更新这个 tag
        # 初始值可以是 latest 或具体的版本号
        image: YOUR_REGISTRY/YOUR_IMAGE_NAME:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8000
          protocol: TCP
        # ... 其他配置 ...

---
# ============================================
# 多 Image 示例（如果有多个容器）
# ============================================
# 如果你的 Deployment 有多个容器需要自动更新：

# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   name: multi-container-app
#   namespace: llm
#   annotations:
#     # 多个 image，每行一个（不用逗号）
#     argocd-image-updater.argoproj.io/image-list: |
#       api=YOUR_REGISTRY/api-image
#       worker=YOUR_REGISTRY/worker-image
#     
#     # 为每个 image 配置不同的更新策略
#     argocd-image-updater.argoproj.io/api.update-strategy: semver
#     argocd-image-updater.argoproj.io/api.allow-tags: regexp:^v?[0-9]+\.[0-9]+\.[0-9]+$
#     
#     argocd-image-updater.argoproj.io/worker.update-strategy: latest
#     
#     argocd-image-updater.argoproj.io/write-back-method: git:secret:argocd/git-credentials
#     argocd-image-updater.argoproj.io/git-branch: main
# spec:
#   template:
#     spec:
#       containers:
#       - name: api
#         image: YOUR_REGISTRY/api-image:latest
#       - name: worker
#         image: YOUR_REGISTRY/worker-image:latest

---
# ============================================
# 更新策略说明
# ============================================
#
# 1. semver（语义化版本）：
#    - 匹配 v1.2.3, 1.2.3, v1.2.3-beta 等
#    - 总是选择最新的版本号
#    - 推荐用于生产环境
#
# 2. latest：
#    - 总是使用 latest tag
#    - 简单但不推荐用于生产
#
# 3. name：
#    - 按 tag 的字符串排序，选择最新的
#    - ⚠️ 不是按时间，不是按 push 时间
#    - ⚠️ 只有在 tag 是严格 zero-padded 的时间戳时才安全
#    - 适用于自定义命名规则（如 v-20240101-235959）
#
# 4. digest：
#    - 使用 image digest（SHA256）
#    - 最安全但需要手动触发更新
