# =========================
# ArgoCD Image Updater Helm Chart Values
# =========================
# 用于通过 Helm 安装和配置 ArgoCD Image Updater

# 镜像配置（升级到稳定版本 v0.15.2）
# 从 v1.0.2 升级到 v0.15.2，解决 Application 发现和 annotations 解析问题
image:
  repository: quay.io/argoprojlabs/argocd-image-updater
  tag: v0.15.2
  pullPolicy: IfNotPresent

# 副本数（当前阶段建议使用 1，避免两个 updater 同时写 Git 的 race 风险）
# 等一切稳定后再开 HA
replicaCount: 1

# Image Updater 配置
config:
  # Application API 类型：使用 ArgoCD API
  applicationsAPIKind: "argocd"

  # ArgoCD 连接配置（集群内访问的最稳妥配置）
  # 原因：集群内通常没有完整 TLS 链，gRPC + https + plaintext=false 极容易握手失败
  argocd:
    serverAddress: "argocd-server.argocd.svc.cluster.local"
    insecure: true

  # 更新间隔（10 秒，用于快速测试；生产环境建议使用 2m）
  interval: 10s

  # 日志配置（正确的键名：log.level 和 log.format）
  log:
    level: info
    format: text

  # Git 写回配置（扁平化格式，符合 Helm chart 要求）
  # 写回方法：git（通过 Git 仓库写回）
  writeBackMethod: git
  # Git commit 用户信息
  gitCommitUser: "Johnny-dai-git"
  gitCommitEmail: "johnny-dai-git@users.noreply.github.com"
  # Git 分支
  gitBranch: "main"
  # Git commit 消息模板
  gitCommitMessage: "build: update {{.AppName}} image {{.ImageName}} to {{.NewTag}}\n\n[skip ci]"
  # 注意：Git credentials 通过 Application annotations 中的 write-back-method 指定
  # 格式：git:secret:argocd/git-credentials

  # Registry 配置（public image 不需要 credentials）
  # 注意：如果镜像都是 public 的，则不需要配置 credentials
  registries:
    - name: GitHub Container Registry
      api_url: https://ghcr.io
      prefix: ghcr.io
      default: true

# ServiceAccount 配置
serviceAccount:
  # 如果设置为空字符串，则使用默认的 ServiceAccount
  # 如果需要自定义 ServiceAccount，请取消注释并设置名称
  # name: argocd-image-updater
  # 是否自动挂载 ServiceAccount token
  automountServiceAccountToken: true

# Pod 调度配置
nodeSelector: {}
# 示例：
# nodeSelector:
#   kubernetes.io/os: linux

tolerations: []
# 示例：
# tolerations:
#   - key: "node-role.kubernetes.io/master"
#     operator: "Exists"
#     effect: "NoSchedule"

affinity: {}
# 示例：Pod 反亲和性，确保 Pod 分布在不同节点
# affinity:
#   podAntiAffinity:
#     preferredDuringSchedulingIgnoredDuringExecution:
#       - weight: 100
#         podAffinityTerm:
#           labelSelector:
#             matchExpressions:
#               - key: app.kubernetes.io/name
#                 operator: In
#                 values:
#                   - argocd-image-updater
#           topologyKey: kubernetes.io/hostname

# 资源限制
resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

# 容器启动命令配置（重要！）
# 修复：v0.15.2 镜像中没有 /manager 二进制，必须使用镜像自带的 entrypoint
# 不设置 command/args，让镜像使用自带的 ENTRYPOINT: /usr/local/bin/argocd-image-updater
# 如果 Helm chart 模板中有默认的 command: ["/manager"]，这个配置会覆盖它
command: []
args: []

# 环境变量配置（可选）
extraEnv: []
# 示例：
# extraEnv:
#   - name: LOG_LEVEL
#     value: "debug"

# 配置说明：
# - Git credentials Secret (git-credentials) 需要在安装前创建
# - 如果镜像都是 public 的，则不需要 Docker registry Secret
# - Application annotations 中需要引用: git:secret:argocd/git-credentials
# - 所有配置格式已根据官方 Helm chart 格式修复
