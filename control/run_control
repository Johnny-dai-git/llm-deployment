#!/bin/bash
set -e

echo "================ Step 1: Apply namespaces ================"
kubectl apply -f namespaces/


echo "================ Step 2: Label nodes ====================="

CONTROL_NODE="control"
SYSTEM_NODE="system"
GPU_NODE1="worker-1"
GPU_NODE2="worker-2"

echo "Labeling control node..."
kubectl label node $CONTROL_NODE control=true --overwrite

echo "Labeling system node..."
kubectl label node $SYSTEM_NODE system=true ingress=true --overwrite

echo "Labeling GPU nodes..."
kubectl label node $GPU_NODE1 gpu-node=true --overwrite
kubectl label node $GPU_NODE2 gpu-node=true --overwrite


echo "================ Step 3: Deploy MetalLB =================="

# Step 3.1: å®‰è£…å®˜æ–¹ MetalLBï¼ˆåŒ…å« controller, speaker, RBAC ç­‰ï¼‰
echo ">>> å®‰è£…å®˜æ–¹ MetalLB..."
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/manifests/metallb-native.yaml

# Step 3.2: ç­‰å¾… MetalLB ç»„ä»¶å°±ç»ª
echo ">>> ç­‰å¾… MetalLB ç»„ä»¶å°±ç»ª..."
sleep 10

# Step 3.3: Patch controller resources
echo ">>> é…ç½® MetalLB controller resources..."
kubectl -n metallb-system patch deployment controller \
  --type='json' \
  -p='[
    {"op":"add","path":"/spec/template/spec/containers/0/resources",
     "value":{"requests":{"cpu":"100m","memory":"128Mi"},
              "limits":{"cpu":"300m","memory":"512Mi"}}}
  ]' || echo "âš  Controller å¯èƒ½è¿˜æœªå°±ç»ªï¼Œç¨åéœ€è¦æ‰‹åŠ¨ patch"

# Step 3.4: Patch speaker resources
echo ">>> é…ç½® MetalLB speaker resources..."
kubectl -n metallb-system patch daemonset speaker \
  --type='json' \
  -p='[
    {"op":"add","path":"/spec/template/spec/containers/0/resources",
     "value":{"requests":{"cpu":"50m","memory":"64Mi"},
              "limits":{"cpu":"200m","memory":"256Mi"}}}
  ]' || echo "âš  Speaker å¯èƒ½è¿˜æœªå°±ç»ªï¼Œç¨åéœ€è¦æ‰‹åŠ¨ patch"

# Step 3.5: Apply MetalLB IP pool é…ç½®ï¼ˆä½¿ç”¨ system node IPï¼‰
echo ">>> åº”ç”¨ MetalLB IP pool é…ç½®..."
kubectl apply -f config/k8s/base/metallb/metallb-ip-pool.yaml

kubectl get configmap -n metallb-system || true


echo "================ Step 4: Deploy ingress-nginx ============"
kubectl apply -f ingress-nginx/


echo "================ Step 5: Deploy ArgoCD ==================="
# Step 5.1: åˆ›å»º ArgoCD namespace
echo ">>> åˆ›å»º ArgoCD namespace..."
kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -

# Step 5.2: å®‰è£…å®˜æ–¹ ArgoCDï¼ˆåŒ…å«æ‰€æœ‰ç»„ä»¶ï¼šserver, repo-server, application-controller, redis, dex-server ç­‰ï¼‰
echo ">>> å®‰è£…å®˜æ–¹ ArgoCD..."
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# Step 5.3: ç­‰å¾… ArgoCD ç»„ä»¶å°±ç»ª
echo ">>> ç­‰å¾… ArgoCD ç»„ä»¶å°±ç»ª..."
sleep 15

# Step 5.4: ç­‰å¾… ArgoCD Service å°±ç»ª
echo ">>> ç­‰å¾… ArgoCD Service å°±ç»ª..."
sleep 5

# Step 5.5: éƒ¨ç½² ArgoCD Ingress
echo ">>> éƒ¨ç½² ArgoCD Ingress..."
kubectl apply -f config/k8s/argocd/argocd-ingress.yaml

# Step 5.6: ç­‰å¾… ArgoCD å®Œå…¨å°±ç»ª
echo ">>> ç­‰å¾… ArgoCD å®Œå…¨å°±ç»ª..."
sleep 10

# Step 5.7: éƒ¨ç½² ArgoCD Applicationsï¼ˆGitOpsï¼‰
echo ">>> éƒ¨ç½² ArgoCD Applications..."
kubectl apply -f config/k8s/argocd/base-application.yaml
kubectl apply -f config/k8s/argocd/llm-application.yaml
kubectl apply -f config/k8s/argocd/monitoring-application.yaml
kubectl apply -f config/k8s/argocd/argocd-ingress-application.yaml

# Step 5.8: æ˜¾ç¤º ArgoCD åˆå§‹ admin å¯†ç 
echo ">>> ArgoCD åˆå§‹ admin å¯†ç ï¼š"
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" 2>/dev/null | base64 -d && echo || echo "âš  å¯†ç å¯èƒ½è¿˜æœªç”Ÿæˆï¼Œç¨åè¿è¡Œ: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d"
echo ">>> ArgoCD UI: http://149.165.147.30/argocd (ç­‰å¾… Ingress ç”Ÿæ•ˆåè®¿é—®)"


echo "================ Step 6: Install ArgoCD Image Updater ==================="
# Step 6.1: å®‰è£… ArgoCD Image Updater
echo ">>> å®‰è£… ArgoCD Image Updater..."
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj-labs/argocd-image-updater/stable/manifests/install.yaml

# Step 6.2: ç­‰å¾… Image Updater å°±ç»ª
echo ">>> ç­‰å¾… ArgoCD Image Updater å°±ç»ª..."
sleep 10

# Step 6.3: æ£€æŸ¥çŠ¶æ€
echo ">>> æ£€æŸ¥ ArgoCD Image Updater çŠ¶æ€..."
kubectl get pods -n argocd | grep image-updater || echo "âš  Image Updater å¯èƒ½è¿˜æœªå°±ç»ª"

# Step 6.4: æç¤ºé…ç½® Secretï¼ˆå¦‚æœéœ€è¦ï¼‰
echo ""
echo ">>> ğŸ“ æ³¨æ„ï¼šå¦‚æœéœ€è¦ä½¿ç”¨ Image Updaterï¼Œè¯·é…ç½®ä»¥ä¸‹ Secretï¼š"
echo "   1. Docker Registry è®¤è¯ï¼ˆå¦‚æœéœ€è¦ç§æœ‰ä»“åº“ï¼‰ï¼š"
echo "      kubectl apply -f config/k8s/argocd/image-updater/docker-registry-secret.yaml"
echo "   2. Git å†™å›å‡­è¯ï¼ˆImage Updater éœ€è¦å†™å› Gitï¼‰ï¼š"
echo "      kubectl apply -f config/k8s/argocd/image-updater/git-credentials-secret.yaml"
echo "   3. åœ¨ Deployment ä¸­å·²æ·»åŠ  Image Updater annotationsï¼ˆå ä½ç¬¦ï¼‰"
echo "      è¯·ä¿®æ”¹ Deployment ä¸­çš„ YOUR_REGISTRY ä¸ºå®é™…çš„ registry åœ°å€"


echo "================ Step 7: Check Status ==================="
kubectl get nodes -o wide
kubectl get pods -A -o wide
kubectl get svc -A

echo ""
echo "=========================================================="
echo "ğŸš€ Infrastructure deployed successfully from CONTROL NODE!"
echo ""
echo "ğŸ“‹ éƒ¨ç½²è¯´æ˜ï¼š"
echo "   - åŸºç¡€è®¾æ–½ï¼ˆMetalLB, ingress-nginx, ArgoCDï¼‰å·²éƒ¨ç½²"
echo "   - ArgoCD Applications å·²åˆ›å»ºï¼Œå°†ä» Git ä»“åº“åŒæ­¥éƒ¨ç½²æ‰€æœ‰æœåŠ¡"
echo "   - æ‰€æœ‰æœåŠ¡ï¼ˆLLM Web/API/Router/Workers/Monitoringï¼‰å°†ç”± ArgoCD ç®¡ç†"
echo ""
echo "ğŸ” æ£€æŸ¥çŠ¶æ€ï¼š"
echo "   - Ingress External IP:"
echo "     kubectl get svc -n ingress-nginx"
echo "   - ArgoCD Applications çŠ¶æ€:"
echo "     kubectl get applications -n argocd"
echo "   - ArgoCD UI:"
echo "     http://149.165.147.30/argocd"
echo "   - ArgoCD admin password:"
echo "     kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d"
echo ""
echo "ğŸŒ æœåŠ¡è®¿é—®åœ°å€ï¼ˆç­‰å¾… ArgoCD åŒæ­¥åï¼‰ï¼š"
echo "   - LLM Web:    http://149.165.147.30/"
echo "   - LLM API:    http://149.165.147.30/api"
echo "   - Grafana:    http://149.165.147.30/grafana"
echo "   - ArgoCD:     http://149.165.147.30/argocd"
echo ""
echo "ğŸ“ ä¸‹ä¸€æ­¥ï¼š"
echo "   1. ç¡®ä¿ Git ä»“åº“åŒ…å«æ‰€æœ‰ YAML æ–‡ä»¶"
echo "   2. åœ¨ ArgoCD UI ä¸­æ£€æŸ¥ Applications åŒæ­¥çŠ¶æ€"
echo "   3. å¦‚éœ€ä½¿ç”¨ Image Updaterï¼Œé…ç½® Docker Registry å’Œ Git å‡­è¯"
echo "=========================================================="

