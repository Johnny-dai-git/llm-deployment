#!/bin/bash
set -e

echo "================ Step 1: Apply namespaces ================"
kubectl apply -f namespaces/


echo "================ Step 1.5: Create ghcr-secret ============"
# Create ghcr.io authentication Secret (for pulling private images)
echo ">>> Creating ghcr-secret (GitHub Container Registry authentication)..."
if [ -f "config/k8s/llm/secrets/ghcr-secret.yaml" ]; then
    kubectl apply -f config/k8s/llm/secrets/ghcr-secret.yaml
    echo "‚úî ghcr-secret created"
    echo ">>> Verifying ghcr-secret status:"
    kubectl get secret ghcr-secret -n llm
    echo "‚úî ghcr-secret verification successful"
else
    echo "‚ö† Warning: config/k8s/llm/secrets/ghcr-secret.yaml file does not exist"
    echo "   Please ensure GitHub token and username are configured"
fi


echo "================ Step 2: Label nodes ====================="

CONTROL_NODE="control"
SYSTEM_NODE="system"
GPU_NODE1="worker-1"
GPU_NODE2="worker-2"

echo "Labeling control node..."
kubectl label node $CONTROL_NODE control=true --overwrite

echo "Labeling system node..."
kubectl label node $SYSTEM_NODE system=true ingress=true --overwrite

echo "Labeling GPU nodes..."
kubectl label node $GPU_NODE1 gpu-node=true --overwrite
kubectl label node $GPU_NODE2 gpu-node=true --overwrite


echo "================ Step 3: Deploy MetalLB =================="

# Step 3.1: Install official MetalLB (includes controller, speaker, RBAC, etc.)
echo ">>> Installing official MetalLB..."
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/manifests/metallb-native.yaml

# Step 3.2: Wait for MetalLB components to be ready
echo ">>> Waiting for MetalLB components to be ready..."
sleep 10

# Step 3.3: Patch controller resources
echo ">>> Configuring MetalLB controller resources..."
kubectl -n metallb-system patch deployment controller \
  --type='json' \
  -p='[
    {"op":"add","path":"/spec/template/spec/containers/0/resources",
     "value":{"requests":{"cpu":"100m","memory":"128Mi"},
              "limits":{"cpu":"300m","memory":"512Mi"}}}
  ]' || echo "‚ö† Controller may not be ready yet, manual patch required later"

# Step 3.4: Patch speaker resources
echo ">>> Configuring MetalLB speaker resources..."
kubectl -n metallb-system patch daemonset speaker \
  --type='json' \
  -p='[
    {"op":"add","path":"/spec/template/spec/containers/0/resources",
     "value":{"requests":{"cpu":"50m","memory":"64Mi"},
              "limits":{"cpu":"200m","memory":"256Mi"}}}
  ]' || echo "‚ö† Speaker may not be ready yet, manual patch required later"

# Step 3.5: Apply MetalLB IP pool configuration (using system node IP)
echo ">>> Applying MetalLB IP pool configuration..."
kubectl apply -f config/k8s/base/metallb/metallb-ip-pool.yaml

kubectl get configmap -n metallb-system || true


echo "================ Step 4: Deploy ingress-nginx ============"
kubectl apply -f ingress-nginx/


echo "================ Step 5: Deploy ArgoCD ==================="
# Step 5.1: Create ArgoCD namespace
echo ">>> Creating ArgoCD namespace..."
kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -

# Step 5.2: Install official ArgoCD (includes all components: server, repo-server, application-controller, redis, dex-server, etc.)
echo ">>> Installing official ArgoCD..."
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# Step 5.3: Wait for ArgoCD components to be ready
echo ">>> Waiting for ArgoCD components to be ready..."
sleep 15

# Step 5.4: Wait for ArgoCD Service to be ready
echo ">>> Waiting for ArgoCD Service to be ready..."
sleep 5

# Step 5.5: Deploy ArgoCD Ingress
echo ">>> Deploying ArgoCD Ingress..."
kubectl apply -f config/k8s/argocd/argocd-ingress.yaml

# Step 5.6: Wait for ArgoCD to be fully ready
echo ">>> Waiting for ArgoCD to be fully ready..."
sleep 10

# Step 5.7: Deploy ArgoCD Applications (GitOps)
echo ">>> Deploying ArgoCD Applications..."
kubectl apply -f config/k8s/argocd/base-application.yaml
kubectl apply -f config/k8s/argocd/llm-application.yaml
kubectl apply -f config/k8s/argocd/monitoring-application.yaml
kubectl apply -f config/k8s/argocd/argocd-ingress-application.yaml

# Step 5.8: Display ArgoCD initial admin password
echo ">>> ArgoCD initial admin password:"
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" 2>/dev/null | base64 -d && echo || echo "‚ö† Password may not be generated yet, run later: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d"
echo ">>> ArgoCD UI: http://149.165.147.30/argocd (access after Ingress takes effect)"


echo "================ Step 6: Install ArgoCD Image Updater ==================="
# Step 6.1: Install ArgoCD Image Updater
echo ">>> Installing ArgoCD Image Updater..."
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj-labs/argocd-image-updater/stable/manifests/install.yaml

# Step 6.2: Wait for Image Updater to be ready
echo ">>> Waiting for ArgoCD Image Updater to be ready..."
sleep 10

# Step 6.3: Check status
echo ">>> Checking ArgoCD Image Updater status..."
kubectl get pods -n argocd | grep image-updater || echo "‚ö† Image Updater may not be ready yet"

# Step 6.4: Prompt to configure Secret (if needed)
echo ""
echo ">>> üìù Note: If you need to use Image Updater, configure the following Secrets:"
echo "   1. Docker Registry authentication (if private registry is needed):"
echo "      kubectl apply -f config/k8s/argocd/image-updater/docker-registry-secret.yaml"
echo "   2. Git write-back credentials (Image Updater needs to write back to Git):"
echo "      kubectl apply -f config/k8s/argocd/image-updater/git-credentials-secret.yaml"
echo "   3. Image Updater annotations have been added to Deployment (placeholder)"
echo "      Please modify YOUR_REGISTRY in Deployment to the actual registry address"


echo "================ Step 7: Check Status ==================="
kubectl get nodes -o wide
kubectl get pods -A -o wide
kubectl get svc -A

echo ""
echo ">>> Verifying critical Secret status:"
kubectl get secret ghcr-secret -n llm || echo "‚ö† ghcr-secret does not exist, please check"

echo ""
echo "=========================================================="
echo "üöÄ Infrastructure deployed successfully from CONTROL NODE!"
echo ""
echo "üìã Deployment Notes:"
echo "   - Infrastructure (MetalLB, ingress-nginx, ArgoCD) has been deployed"
echo "   - ghcr-secret has been created and can be used to pull ghcr.io private images"
echo "   - ArgoCD Applications have been created and will sync and deploy all services from Git repository"
echo "   - All services (LLM Web/API/Router/Workers/Monitoring) will be managed by ArgoCD"
echo ""
echo "üîç Check Status:"
echo "   - Ingress External IP:"
echo "     kubectl get svc -n ingress-nginx"
echo "   - ArgoCD Applications status:"
echo "     kubectl get applications -n argocd"
echo "   - ghcr-secret status:"
echo "     kubectl get secret ghcr-secret -n llm"
echo "   - ArgoCD UI:"
echo "     http://149.165.147.30/argocd"
echo "   - ArgoCD admin password:"
echo "     kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d"
echo ""
echo "üåê Service Access Addresses (after ArgoCD sync):"
echo "   - LLM Web:    http://149.165.147.30/"
echo "   - LLM API:    http://149.165.147.30/api"
echo "   - Grafana:    http://149.165.147.30/grafana"
echo "   - ArgoCD:     http://149.165.147.30/argocd"
echo ""
echo "üìù Next Steps:"
echo "   1. Ensure Git repository contains all YAML files"
echo "   2. Check Applications sync status in ArgoCD UI"
echo "   3. If you need to use Image Updater, configure Docker Registry and Git credentials"
echo "=========================================================="
