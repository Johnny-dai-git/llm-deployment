# kube-prometheus-stack Helm Values
# 适配当前配置：子路径、Ingress、资源限制

# ---------- Grafana ----------
grafana:
  enabled: true

  # 资源限制（匹配当前配置）
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"
  
  # Node Selector（匹配当前配置）
  nodeSelector:
    system: "true"

  # 管理员凭证（匹配当前配置）
  adminUser: admin
  adminPassword: admin

  # Ingress 配置（子路径支持）
  ingress:
    enabled: true
    ingressClassName: nginx
    path: /grafana
    pathType: Prefix
    hosts: []
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "false"
      nginx.ingress.kubernetes.io/proxy-body-size: "50m"
      nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
      nginx.ingress.kubernetes.io/rewrite-target: /

  # Grafana 配置（子路径支持）
  grafana.ini:
    server:
      root_url: "%(protocol)s://%(domain)s/grafana/"
      serve_from_sub_path: true
  
  # Persistence（匹配当前配置）
  persistence:
    enabled: true
    type: pvc
    storageClassName: ""
    accessModes:
      - ReadWriteOnce
    size: 10Gi

# ---------- Prometheus ----------
prometheus:
  enabled: true
  
  # 资源限制（匹配当前配置）
  prometheusSpec:
    resources:
      requests:
        cpu: "500m"
        memory: "1Gi"
      limits:
        cpu: "2"
        memory: "4Gi"
    
    # Node Selector（匹配当前配置）
    nodeSelector:
      system: "true"
    
    # 自定义 scrape configs（保留当前的配置）
    additionalScrapeConfigs:
      # dcgm-exporter（通过 ServiceMonitor 自动发现，但也可以手动配置）
      - job_name: "dcgm-exporter"
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - monitoring
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name]
            action: keep
            regex: dcgm-exporter
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            action: keep
            regex: http
      
      # LLM System Monitoring
      - job_name: "kubernetes-pods-llm"
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - llm
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
          - source_labels: [__meta_kubernetes_pod_container_name]
            action: replace
            target_label: kubernetes_container_name
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: replace
            target_label: job
            regex: (.+)
            replacement: ${1}
    
    # Persistence（匹配当前配置）
    retention: 30d
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi
  
  # Prometheus Ingress
  ingress:
    enabled: true
    ingressClassName: nginx
    path: /prometheus
    pathType: Prefix
    hosts: []
    annotations:
      nginx.ingress.kubernetes.io/rewrite-target: /

# ---------- Alertmanager ----------
alertmanager:
  enabled: true
  alertmanagerSpec:
    nodeSelector:
      system: "true"

# ---------- Node Exporter（由 Helm 管理）----------
nodeExporter:
  enabled: true

# ---------- Kube State Metrics（由 Helm 管理）----------
kubeStateMetrics:
  enabled: true
