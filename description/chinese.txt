CI/DI

══════════════════════ CI/CD（持续集成 / 持续部署平面）═══════════════════════

┌──────────────────────────────────────────────────────────────────────┐
│                        开发者本地环境                                  │
│  - llm-api / router / worker 代码                                     │
│  - Dockerfile / Kubernetes YAML / Helm                                │
│  - Git Commit & Push                                                   │
└───────────────────────┬──────────────────────────────────────────────┘
                            │ Git Push
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                 GitHub Actions Runner                                  │
│   (Self-hosted Runner，运行在本地机器上)                              │
│  - 单元测试 / 集成测试                                                 │
│  - 构建 Docker 镜像：                                                  │
│      * llm-api                                                         │
│      * router                                                          │
│      * bert-worker / vllm-worker / trt-worker                          │
│  - 镜像打 Tag（semver: v1.2.3）                                        │
│  - Push 到 Docker Registry                                             │
│  (注：未来可迁移到 Kubernetes 集群内运行，使用 Actions Runner Controller)│
└───────────────────────┬──────────────────────────────────────────────┘
                            │ Image Push
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    Docker Registry                                   │
│  your-registry/llm-api                                               │
│  your-registry/router                                                │
│  your-registry/vllm-worker                                           │
│  your-registry/trt-worker                                            │
└───────────────────────┬──────────────────────────────────────────────┘
                            │ Image Scan
════════════════════════ argocd 命名空间（控制平面）══════════════════════════
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│              ArgoCD Image Updater                                      │
│  - 定期扫描 Registry                                                   │
│  - 匹配 semver / tag 规则                                              │
│  - 自动修改 Git 中 Deployment 的 image tag                             │
│  - Commit & Push（GitOps）                                             │
└───────────────────────┬──────────────────────────────────────────────┘
                            │ Git 更新
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    Git 仓库（GitOps 单一事实源）                        │
│  - 所有 Kubernetes YAML                                                │
│  - llm / ingress / router / worker                                     │
│  - Image tag 由 Image Updater 自动维护                                 │
└───────────────────────┬──────────────────────────────────────────────┘
                            │ Git Diff
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│              ArgoCD Application Controller                             │
│  - 监听 Git 状态变化                                                   │
│  - 自动 Sync 到 Kubernetes 集群                                        │
│  - 支持健康检查 / 回滚                                                │
└───────────────────────┬──────────────────────────────────────────────┘
                            │ Apply
════════════════════════ Kubernetes 集群（运行时平面）══════════════════════════





                           ┌─────────────────────────────┐
                           │        外部客户端           │
                           │ (浏览器 / 后端服务 / CLI)   │
                           └──────────────┬──────────────┘
                                          │  HTTPS
                                          ▼
═══════════════════════ metallb-system 命名空间 ═══════════════════════════════

                    ┌───────────────────────────────────────────┐
                    │           MetalLB External IP             │
                    │   （稳定的四层入口，BGP / L2 广播）       │
                    └───────────────────┬───────────────────────┘
                                        │
                                        ▼
═══════════════════════ ingress-nginx 命名空间 ═══════════════════════════════

        ┌────────────────────────────────────────────────────────────────────┐
        │ Service: ingress-nginx (type=LoadBalancer)                        │
        │ - 由 MetalLB 分配外部 IP                                         │
        │ - 四层负载均衡 + 第一层安全边界                                  │
        └───────────────────────┬───────────────────────────────────────────┘
                                │
                                ▼
        ┌────────────────────────────────────────────────────────────────────┐
        │      Ingress Controller Pods (2–3 副本，高可用)                    │
        │ - 终止 TLS                                                        │
        │ - 按 Host / Path 做七层路由                                      │
        │ - 统一入口转发到 llm 业务命名空间                                 │
        └───────────────┬────────────────────────────────────────────────────┘
                        │
        ┌───────────────┴─────────────────────────┐
        │                                         │
        ▼                                         ▼

════════════════════════════ llm 命名空间（业务平面） ═════════════════════════════

   ┌─────────────────────────────┐           ┌───────────────────────────────┐
   │       llm-web-service       │           │         llm-api-service       │
   │  (ClusterIP，四层 LB)       │           │  (ClusterIP，API 网关)        │
   └───────────┬─────────────────┘           └───────────────┬──────────────┘
               │                                             │
               ▼                                             ▼
   ┌─────────────────────────────┐           ┌───────────────────────────────┐
   │        llm-web Pods         │           │         llm-api Pods          │
   │  (静态网页 / Chat UI)       │           │ - 鉴权 / 限流 / 日志           │
   │                             │           │ - 请求校验 / 业务封装         │
   └─────────────────────────────┘           └───────────────┬──────────────┘
                                                             │
                                                             ▼

═══════════════════════ Router（调度与多模型路由）═══════════════════════════════

                            ┌───────────────────────────┐
                            │   router-service (L7 LB)  │
                            │ - 多模型调度核心组件       │
                            │ - 选择合适的 worker       │
                            └─────────────┬─────────────┘
                                          │
                        ┌─────────────────┼───────────────────┐
                        │                 │                   │
                        ▼                 ▼                   ▼

═══════════ 多模型 Worker 服务（集群内部的三类 L4 LB）═══════════════════════════

      ┌────────────────────────┐ ┌────────────────────────┐ ┌────────────────────────┐
      │ bert-worker-service    │ │ vllm-worker-service    │ │ trt-worker-service     │
      │ (ClusterIP)            │ │ (ClusterIP)            │ │ (ClusterIP)            │
      │ - BERT 轻模型服务      │ │ - vLLM 大模型推理      │ │ - TensorRT-LLM 加速    │
      └───────────┬────────────┘ └───────────┬────────────┘ └───────────┬────────────┘
                  │                          │                           │
                  ▼                          ▼                           ▼

══════════════════════ LLM Worker Pods（真实 GPU 推理层）═══════════════════════

      ┌────────────────────────┐ ┌────────────────────────┐ ┌────────────────────────┐
      │   BERT Worker Pods     │ │    vLLM Worker Pods    │ │ TensorRT-LLM Pods      │
      │ - 嵌入/分类任务         │ │ - KV cache / 大模型推理 │ │ - 高吞吐低延迟推理      │
      │ - CPU/GPU              │ │ - GPU 必需             │ │ - GPU 必需             │
      │ - 挂载 /model          │ │ - 挂载 /model          │ │ - 挂载 /model          │
      └───────┬────────────────┘ └───────────┬────────────┘ └───────────┬────────────┘
              │                                │                            │
              └──────────────┬─────────────────┴────────────────────────────┘
                             │
                             ▼

════════════════════════════ Storage（模型存储）══════════════════════════════════

      ┌──────────────────────────────────────────────┐
      │ /model 挂载点（节点本地目录 → Pod 挂载）     │
      │ - 模型文件预先放在 GPU 节点本地磁盘         │
      │ - 通过 hostPath 等方式挂载到各 Worker Pod   │
      │ - 每个 Worker 容器内统一使用 /model 访问模型 │
      └──────────────────────────────────────────────┘


══════════════════════ NetworkPolicy（零信任网络边界）═══════════════════════════

   - 只允许 ingress-nginx → llm-api-service  
   - 只允许 llm-api Pods → router-service  
   - 只允许 router Pods → 各类 worker-service  
   - 默认拒绝跨命名空间访问  



══════════════════════ Monitoring（可观测性平面）════════════════════════════════

    ┌──────────────────────────────────────────────────────────────────────┐
    │                            Prometheus                               │
    │  抓取：                                                             │
    │   - llm-web-service.llm.svc:       HTTP RPS / 错误率 / 延迟         │
    │   - llm-api-service.llm.svc:       API QPS / 并发 / 错误类型        │
    │   - router-service.llm.svc:        队列长度 / 分发延迟              │
    │   - bert/vllm/trt worker:          tokens/sec / 吞吐 / 延迟         │
    │   - gpu-exporter / node-exporter                                     │
    │   - kube-state-metrics                                                │
    └──────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
                        ┌──────────────────────────┐
                        │         Grafana          │
                        │ - API 延迟 p50/p95/p99   │
                        │ - 模型吞吐与 tokens/sec  │
                        │ - GPU 利用率 / 显存 / ECC │
                        │ - router 排队深度         │
                        │ - 节点与 Pod 健康         │
                        └──────────────────────────┘

